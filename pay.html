<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–û–∑–µ—Ä–æ –î—ñ–¥–∏–ª—ñ–≤ ‚Äî —á–µ–∫–∏</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;max-width:900px;margin:24px auto;padding:0 16px}
header{display:flex;align-items:center;gap:16px;margin-bottom:20px}
header img{height:70px}
fieldset{border:1px solid #ccc;border-radius:10px;padding:12px 16px;margin-bottom:20px}
legend{font-weight:600}
.row{display:flex;flex-wrap:wrap;gap:12px}
.row>div{flex:1;min-width:200px}
button{padding:10px 14px;border:0;border-radius:8px;cursor:pointer}
button.primary{background:#2a7;color:#fff}
button.secondary{background:#eef}
button.warn{background:#ffd966}
button.danger{background:#fdd}
#participantsList{margin-top:10px}
.participant{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid #eee}
.participant label{white-space:nowrap}
.participant .sum{min-width:90px;text-align:right;font-weight:600}
#totalSum{font-weight:700;text-align:right;margin-top:8px}
.previewWrap{display:grid;grid-template-columns: 220px 220px 220px 220px;gap:5px;margin-top:10px}
.ticketPreview{border:1px dashed #ddd;border-radius:8px;padding:12px;background:#fafafa}
.ticketPreview pre{margin:0;font-family:monospace;font-size:12px;white-space:pre-wrap}
.ticketPreview .qr{margin-top:8px;text-align:center}
.ticketPreview img.logo{display:block;margin:0 auto 6px auto;max-height:160px}
#status{font-size:12px;color:#555;white-space:pre-wrap;margin-top:12px}
.small{font-size:12px;color:#666}
</style>
</head>
<body>
<header>
  <!-- –ú–æ–∂–µ—à –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ logo.png –∞–±–æ logo.svg ‚Äî –æ–±–∏–¥–≤–∞ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –ø—ñ–¥—Ç—Ä–∏–º–∞–Ω—ñ -->
  <img id="logo" src="logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø –û–∑–µ—Ä–æ –î—ñ–¥–∏–ª—ñ–≤">
  <h2>–î—Ä—É–∫ —á–µ–∫—ñ–≤ ‚Äî –û–∑–µ—Ä–æ –î—ñ–¥–∏–ª—ñ–≤</h2>
</header>

<fieldset>
  <legend>–°–ø–∏—Å–æ–∫ —É—á–∞—Å–Ω–∏–∫—ñ–≤</legend>
  <div class="row" style="justify-content:flex-end">
    <button id="add" class="secondary">‚ûï –î–æ–¥–∞—Ç–∏ —É—á–∞—Å–Ω–∏–∫–∞</button>
    <button id="remove" class="danger">‚ùå –í–∏–¥–∞–ª–∏—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ</button>
    <button id="clear" class="danger">‚ùå –í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ—Ö</button>
  </div>
  <div id="participantsList"></div>
  <div id="totalSum">–†–∞–∑–æ–º: 0 –≥—Ä–Ω</div>
</fieldset>

<fieldset>
  <legend>–î—ñ—ó</legend>
  <div class="row">
    <button id="connectBtn" class="warn">üîå –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏ –ø—Ä–∏–Ω—Ç–µ—Ä</button>
    <!-- <button id="previewBtn" class="secondary">üëÅÔ∏è –û–Ω–æ–≤–∏—Ç–∏ –ø—Ä–µ–≤ º—é</button> -->
    <button id="testBtn" class="secondary">üß™ –¢–µ—Å—Ç–æ–≤–∏–π —á–µ–∫</button>
    <button id="printBtn" class="primary">üñ®Ô∏è –î—Ä—É–∫—É–≤–∞—Ç–∏ –≤—Å—ñ —á–µ–∫–∏</button>
  </div>
</fieldset>

<h3>–ü—Ä–µ–≤ º—é —á–µ–∫—ñ–≤</h3>
<div id="preview" class="previewWrap"></div>

<pre id="status"></pre>

<script>
/* ===== –£—Ç–∏–ª—ñ—Ç–∏ —Ç–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏ ===== */
const $=id=>document.getElementById(id);
const nowStr=()=>new Date().toLocaleString('uk-UA',{hour12:false}).replace(',', '');
const LOGO_THRESHOLD = 190; // –≤–∏—â–µ = —Å–≤—ñ—Ç–ª—ñ—à–µ; –Ω–∏–∂—á–µ = —Ç–µ–º–Ω—ñ—à–µ
const PRINT_WIDTH = 384;    // —à–∏—Ä–∏–Ω–∞ –¥—Ä—É–∫—É –±—ñ–ª—å—à–æ—Å—Ç—ñ 58/80–º–º –≥–æ–ª–æ–≤–æ–∫

/* ===== –£—á–∞—Å–Ω–∏–∫–∏ ===== */
let participants=[];
function calcSum(p){let s=300; if(p.tools)s+=200; if(p.discount)s/=2; return Math.round(s);}
function addParticipant(){
  const id=participants.length?participants[participants.length-1].id+1:1;
  participants.push({id,discount:false,tools:false});
  renderList();
}
function removeParticipant(){
  participants.pop();
  renderList();
}
function clearParticipants(){
  participants = [];
  renderList();
}
function toggleField(id,field,val){
  const p=participants.find(x=>x.id===id);
  if(p)p[field]=val;
  updateTotals();
}
function renderList(){
  const wrap=$('participantsList');wrap.innerHTML='';
  participants.forEach(p=>{
    const row=document.createElement('div');
    row.className='participant';
    row.innerHTML=`
      <span>#${p.id}</span>
      <label><input type="checkbox" ${p.discount?'checked':''}> –ü—ñ–ª—å–≥–∞ ‚àí50%</label>
      <label><input type="checkbox" ${p.tools?'checked':''}> –û—Ä–µ–Ω–¥–∞ —ñ–Ω–≤–µ–Ω—Ç–∞—Ä—é</label>
      <span class="sum">${calcSum(p)} –≥—Ä–Ω</span>`;
    const [disc,tools]=row.querySelectorAll('input');
    disc.onchange=e=>{toggleField(p.id,'discount',e.target.checked);row.querySelector('.sum').textContent=calcSum(p)+' –≥—Ä–Ω';};
    tools.onchange=e=>{toggleField(p.id,'tools',e.target.checked);row.querySelector('.sum').textContent=calcSum(p)+' –≥—Ä–Ω';};
    wrap.appendChild(row);
  });
  updateTotals();
}
function updateTotals(){
  const t=participants.reduce((s,p)=>s+calcSum(p),0);
  $('totalSum').textContent=`–†–∞–∑–æ–º: ${t} –≥—Ä–Ω`;
  renderPreview();
}
$('add').onclick=addParticipant;
$('remove').onclick=removeParticipant;
$('clear').onclick=clearParticipants;
addParticipant();

/* ===== –î–∞–Ω—ñ / —Ç–µ–∫—Å—Ç / QR ===== */
function buildPayload(p){return{lake:'–û–∑–µ—Ä–æ –î—ñ–¥–∏–ª—ñ–≤',type:'–°–ø—ñ–Ω—ñ–Ω–≥ (—Å–ø–æ—Ä—Ç–∏–≤–Ω–∞ —Ä–∏–±–æ–ª–æ–≤–ª—è)',tools:p.tools,discount:p.discount,amount:calcSum(p),time:nowStr(),participantNo:p.id};}
function buildTextLines(d){
  return[
    `–î–∞—Ç–∞: ${d.time}`,  
    '‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî',
    '–ö–≤–∏—Ç–æ–∫ —Ä–∏–±–∞–ª–∫–∏',
    `${d.type}`,
    `–û—Ä–µ–Ω–¥–∞ —ñ–Ω–≤–µ–Ω—Ç–∞—Ä—é: ${d.tools?'—Ç–∞–∫':'–Ω—ñ'}`,
    `–ü—ñ–ª—å–≥–∞: ${d.discount?'—Ç–∞–∫ (‚àí50%)':'–Ω—ñ'}`,
    `–°—É–º–∞: ${d.amount} –≥—Ä–Ω`,
    '‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî',
    '–ì–∞—Ä–Ω–æ–≥–æ –∫–ª—å–æ–≤—É!',
  ];
}
function buildQrText(){ return 'https://t.me/ozero_didyliv'; }

/* ===== –ü—Ä–µ–≤ º—é ===== */
function renderPreview(){
  const box=$('preview'); box.innerHTML='';
  const logoSrc=$('logo').src;
  for(const p of participants){
    const d=buildPayload(p);
    const card=document.createElement('div'); card.className='ticketPreview';
    const logo=document.createElement('img'); logo.src=logoSrc; logo.className='logo';
    const pre=document.createElement('pre'); pre.textContent=buildTextLines(d).join('\n');
    const qrDiv=document.createElement('div'); qrDiv.className='qr';
    new QRCode(qrDiv,{text:buildQrText(),width:192,height:192,correctLevel:QRCode.CorrectLevel.M});
    card.appendChild(logo); card.appendChild(pre); card.appendChild(qrDiv);
    box.appendChild(card);
  }
  setStatus('‚úÖ –ü—Ä–µ–≤ º—é –æ–Ω–æ–≤–ª–µ–Ω–æ');
}
const prvBtn = $('previewBtn');
if (prvBtn) prvBtn.onclick = renderPreview;

/* ===== ESC/POS / WebUSB ===== */
const ESC=0x1B, GS=0x1D;
const lf=new Uint8Array([0x0A]);
const cut=new Uint8Array([GS,0x56,0x00]);
const alignC=new Uint8Array([ESC,0x61,1]);
const alignL=new Uint8Array([ESC,0x61,0]);
const merge=(...a)=>{let l=0;for(const c of a)l+=c.length;const o=new Uint8Array(l);let i=0;for(const c of a){o.set(c,i);i+=c.length;}return o;};

let device=null, iface=0, altNumber=0, epOut=1;
async function connect(auto = false) {
  try {
    if (auto && device) return;

    if (auto) {
      const saved = await navigator.usb.getDevices();
      if (saved.length) device = saved[0];
    }
    if (!device) {
      device = await navigator.usb.requestDevice({ filters: [{}] });
    }

    await device.open();
    if (!device.configuration) await device.selectConfiguration(1);

    // –§–Ü–ö–° –î–õ–Ø –¢–í–û–ì–û –ü–†–ò–ù–¢–ï–†–ê:
    iface = 0;
    altNumber = 0;
    epOut = 3;

    try { await device.reset(); } catch {}

    await device.claimInterface(iface);
    await device.selectAlternateInterface(iface, altNumber);
    await device.transferOut(epOut, new Uint8Array([0x1B, 0x40])); // ESC @ init

    setStatus(`‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ (iface=${iface}, alt=${altNumber}, epOut=${epOut})`);
  } catch (e) {
    setStatus('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è: ' + e.message + '\n(—Å–ø—Ä–æ–±—É–π –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ –ø—Ä–∏–Ω—Ç–µ—Ä —ñ –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É)');
  }
}


$('connectBtn').onclick=connect;

async function send(b){ if(!device){await connect(); if(!device) return;} await device.transferOut(epOut,b); }
function setStatus(t){$('status').textContent=t;}

/* ===== –†–∞—Å—Ç—Ä–æ–≤–∏–π –¥—Ä—É–∫ ===== */

// Canvas -> ESC/POS raster
function rasterFromCanvas(canvas, threshold=160){
  const w = canvas.width, h = canvas.height;
  const ctx = canvas.getContext('2d', { willReadFrequently:true });
  const data = ctx.getImageData(0,0,w,h).data;

  const bytesPerRow = Math.ceil(w/8);
  const raster = new Uint8Array(bytesPerRow*h);

  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const i=(y*w+x)*4;
      const avg=(data[i]+data[i+1]+data[i+2])/3;
      if(avg<threshold) raster[y*bytesPerRow+(x>>3)]|=(0x80>>(x&7));
    }
  }
  const xL=bytesPerRow&0xFF, xH=bytesPerRow>>8, yL=h&0xFF, yH=h>>8;
  const header=new Uint8Array([GS,0x76,0x30,0x00,xL,xH,yL,yH]);
  return merge(header, raster);
}

// –õ–æ–≥–æ—Ç–∏–ø -> Canvas -> Raster (–±—ñ–ª–∏–π —Ñ–æ–Ω + –ø–æ—Ä—ñ–≥)
async function logoRaster(){
  const imgTag = $('logo');
  if(!imgTag) throw new Error('<img id="logo"> –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
  const src = imgTag.getAttribute('src') || '';
  const isSVG = /\.svg($|\?)/i.test(src);

  let img;
  if(isSVG){
    // –ë–µ–∑–ø–µ—á–Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è SVG —É Bitmap —á–µ—Ä–µ–∑ Blob (–∫—Ä–∞—â–µ —á–µ—Ä–µ–∑ http://)
    const resp = await fetch(src);
    const svgText = await resp.text();
    const blob = new Blob([svgText], { type:'image/svg+xml' });
    const url = URL.createObjectURL(blob);
    img = new Image(); img.crossOrigin='anonymous'; img.src=url;
    await new Promise((res,rej)=>{ img.onload=res; img.onerror=()=>rej(new Error('SVG –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è')); });
    URL.revokeObjectURL(url);
  }else{
    img = imgTag;
    if(!img.complete){ await new Promise((res,rej)=>{ img.onload=res; img.onerror=()=>rej(new Error('–õ–æ–≥–æ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–æ—Å—å')); }); }
  }

  const naturalW = img.naturalWidth || img.width;
  const naturalH = img.naturalHeight || img.height;
  if(!naturalW || !naturalH) throw new Error('–õ–æ–≥–æ –º–∞—î –Ω—É–ª—å–æ–≤–∏–π —Ä–æ–∑–º—ñ—Ä');

  const scale = Math.min(1, PRINT_WIDTH / naturalW);
  const w = Math.round(naturalW * scale);
  const h = Math.round(naturalH * scale);

  const c = document.createElement('canvas'); c.width = w; c.height = h;
  const ctx = c.getContext('2d', { willReadFrequently:true });
  ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h);
  ctx.drawImage(img,0,0,w,h);

  return rasterFromCanvas(c, LOGO_THRESHOLD);
}

// –¢–µ–∫—Å—Ç -> Canvas -> Raster (–∫–æ–Ω—Ç—Ä–æ–ª—å –≤–µ–ª–∏–∫–∏—Ö —à—Ä–∏—Ñ—Ç—ñ–≤)
function textBlockRaster(lines, opts = {}) {
  const {
    width = PRINT_WIDTH,
    regularFont = '24px Arial',   // <-- –∑–±—ñ–ª—å—à–µ–Ω–∏–π —Ä–æ–∑–º—ñ—Ä –∑–≤–∏—á–∞–π–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É
    boldFont = '30px Arial',      // <-- –∑–±—ñ–ª—å—à–µ–Ω–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–ø–µ—Ä—à–∏–π —Ä—è–¥–æ–∫)
    lineHeight = 36,              // <-- –∑–±—ñ–ª—å—à–µ–Ω–∏–π –º—ñ–∂—Ä—è–¥–∫–æ–≤–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª
    center = false,
    padding = 8
  } = opts;

  const height = padding * 2 + lineHeight * lines.length;
  const dpr = 1; // 1:1 –¥–ª—è —Ç–µ—Ä–º–æ–¥—Ä—É–∫—É

  const c = document.createElement('canvas');
  c.width = width * dpr;
  c.height = height * dpr;

  const ctx = c.getContext('2d', { willReadFrequently: true });
  ctx.scale(dpr, dpr);

  ctx.fillStyle = '#fff';
  ctx.fillRect(0, 0, width, height);

  ctx.textBaseline = 'top';
  ctx.fillStyle = '#000';
  ctx.textAlign = center ? 'center' : 'left';

  lines.forEach((t, idx) => {
    ctx.font = (idx === 0 ? boldFont : regularFont);
    const x = center ? Math.floor(width / 2) : padding;
    const y = padding + idx * lineHeight;
    ctx.fillText(t, x, y);
  });

  return rasterFromCanvas(c, 160);
}

// QR -> Canvas -> Raster
async function qrRaster(){
  const holder=document.createElement('div');
  const text = buildQrText();
  new QRCode(holder,{text, width:256, height:256, correctLevel:QRCode.CorrectLevel.M});
  await new Promise(r=>requestAnimationFrame(r));
  const qrCanvas = holder.querySelector('canvas');
  const scale = Math.min(1, PRINT_WIDTH / qrCanvas.width);
  const w = Math.round(qrCanvas.width * scale);
  const h = Math.round(qrCanvas.height * scale);
  const c = document.createElement('canvas'); c.width=w; c.height=h;
  const ctx = c.getContext('2d', { willReadFrequently:true });
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h);
  ctx.drawImage(qrCanvas,0,0,w,h);
  return rasterFromCanvas(c, 160);
}

/* ===== –ö–Ω–æ–ø–∫–∏ –¥—Ä—É–∫—É ===== */
$('testBtn').onclick=async()=>{
  try{
    await connect();
    const logo = await logoRaster();
    const text = textBlockRaster(['–û–ó–ï–†–û –î–Ü–î–ò–õ–Ü–í','–¢–µ—Å—Ç–æ–≤–∏–π –¥—Ä—É–∫'], {
      center:true,
      regularFont:'26px Arial',
      boldFont:'34px Arial',
      lineHeight:38
    });
    const packet=merge(new Uint8Array([ESC,0x40]), alignC, logo, lf, text, lf, cut);
    await send(packet);
    setStatus('‚úÖ –¢–µ—Å—Ç–æ–≤–∏–π —á–µ–∫ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ');
  }catch(e){ setStatus('–ü–æ–º–∏–ª–∫–∞ —Ç–µ—Å—Ç-–¥—Ä—É–∫—É: '+e.message); }
};

$('printBtn').onclick=async()=>{
  try{
    if(!participants.length){setStatus('–î–æ–¥–∞–π —Ö–æ—á–∞ –± –æ–¥–Ω–æ–≥–æ —É—á–∞—Å–Ω–∏–∫–∞');return;}
    await connect(true);
    const logoBytes=await logoRaster();
    for(const p of participants){
      const d=buildPayload(p);
      const textLines = buildTextLines(d);
      const textRaster = textBlockRaster(textLines, {
        center:false,
        regularFont:'24px Arial',
        boldFont:'30px Arial',
        lineHeight:36
      });
      const line = textBlockRaster(['‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî'], { center: true });
      const qrImg = await qrRaster();

      const packet=merge(
        new Uint8Array([ESC,0x40]),
        alignC, logoBytes, lf,
        alignL, textRaster, lf,
        alignC, qrImg, lf,
        lf, line, lf, lf,
        cut
      );
      await send(packet);
    }
    setStatus('‚úÖ –ù–∞–¥—Ä—É–∫–æ–≤–∞–Ω–æ: '+participants.length+' —á–µ–∫(–∏)');
    clearParticipants();
  }catch(e){ setStatus('–ü–æ–º–∏–ª–∫–∞ –¥—Ä—É–∫—É: '+e.message); }
};

</script>
</body>
</html>
